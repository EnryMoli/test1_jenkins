#!/bin/bash

set -xeuo pipefail

CONFIG_FILE="/home/jenkins/agent/config.count"

read_counter() {
  if [ -f "$CONFIG_FILE" ]; then
    read counter < "$CONFIG_FILE"
  else
    counter=0
  fi
  echo $counter
}

write_counter() {
  echo $1 > "$CONFIG_FILE"
}

gcc main.c -o main2

if [ $? -eq 0 ]; then

  echo "compilazione OK"
  counter=$(read_counter)
  # cd /home/jenkins/workspace/task1
  git checkout develop
  git add main2
  git commit -m "Aggiunto eseguibile compilato Nr. $counter" # su develop
  git push -u -f origin develop
  counter=$((counter + 1))
  write_counter "$counter"
  git branch master_local_tmp
  git add master_local_tmp/main2
  git checkout master_local_tmp
  git commit -m "Aggiunto eseguibile compilato Nr. $counter"
  git push -u -f origin master
  exit 0

else
  echo "Errore durante la compilazione"
  exit 1
fi